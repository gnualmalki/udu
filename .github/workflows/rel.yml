name: release

on:
  push:
    tags: ['udu@*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux-x86_64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install GCC
        run: |
          wget -q https://github.com/xpack-dev-tools/gcc-xpack/releases/download/v15.2.0-1/xpack-gcc-15.2.0-1-linux-x64.tar.gz
          tar -xf xpack-gcc-15.2.0-1-linux-x64.tar.gz
          echo "CC=$(pwd)/xpack-gcc-15.2.0-1/bin/gcc" >> $GITHUB_ENV
      - name: Build
        run: |
          rm -rf artifact
          mkdir artifact
          make CC=$CC -B
          cp udu udu.1 COPYING artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-x86_64-linux
          path: artifact/

  build-linux-aarch64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - name: Install GCC
        run: |
          wget -q https://github.com/xpack-dev-tools/gcc-xpack/releases/download/v15.2.0-1/xpack-gcc-15.2.0-1-linux-arm64.tar.gz
          tar -xf xpack-gcc-15.2.0-1-linux-arm64.tar.gz
          echo "CC=$(pwd)/xpack-gcc-15.2.0-1/bin/gcc" >> $GITHUB_ENV
      - name: Build
        run: |
          rm -rf artifact
          mkdir artifact
          make CC=$CC -B
          cp udu udu.1 COPYING artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-aarch64-linux
          path: artifact/

  build-macos-intel:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Install Clang
        run: |
          brew install llvm@21 libomp make
          echo "CC=$(brew --prefix llvm@21)/bin/clang" >> $GITHUB_ENV
          echo "/usr/local/bin" >> $GITHUB_PATH
      - name: Build
        run: |
          rm -rf artifact
          mkdir artifact
          gmake CC=$CC -B
          cp udu udu.1 COPYING artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-x86_64-darwin
          path: artifact/

  build-macos-arm:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Clang
        run: |
          brew install llvm@21 libomp make
          echo "CC=$(brew --prefix llvm@21)/bin/clang" >> $GITHUB_ENV
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
      - name: Build
        run: |
          rm -rf artifact
          mkdir artifact
          gmake CC=$CC -B
          cp udu udu.1 COPYING artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-aarch64-darwin
          path: artifact/

  build-freebsd-x86_64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build on FreeBSD x86_64
        uses: vmactions/freebsd-vm@v1
        with:
          arch: x86_64
          usesh: true
          prepare: pkg install -y gmake
          run: |
            rm -rf artifact
            mkdir artifact
            gmake CC=cc -B
            chmod +x udu
            cp udu udu.1 COPYING artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-x86_64-freebsd
          path: artifact/

  build-freebsd-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build on FreeBSD aarch64
        uses: vmactions/freebsd-vm@v1
        with:
          arch: aarch64
          usesh: true
          prepare: pkg install -y gmake
          run: |
            rm -rf artifact
            mkdir artifact
            gmake CC=cc -B
            chmod +x udu
            cp udu udu.1 COPYING artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-aarch64-freebsd
          path: artifact/

  build-netbsd-x86_64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build on NetBSD x86_64
        uses: vmactions/netbsd-vm@v1
        with:
          release: "10.1"
          arch: x86_64
          usesh: true
          prepare: export PKG_PATH=http://ftp.netbsd.org/pub/pkgsrc/packages/NetBSD/amd64/10.1
          run: |
            /usr/sbin/pkg_add -v pkgin
            pkgin update
            pkgin install -y gmake
            pkgin install -y openmp
            rm -rf artifact
            mkdir artifact
            gmake CC=cc -B
            chmod +x udu
            cp udu udu.1 COPYING artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-x86_64-netbsd
          path: artifact/


  build-netbsd-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build on NetBSD aarch64
        uses: vmactions/netbsd-vm@v1
        with:
          release: "10.1"
          arch: aarch64
          usesh: true
          prepare: export PKG_PATH=http://ftp.netbsd.org/pub/pkgsrc/packages/NetBSD/aarch64/10.1
          run: |
            /usr/sbin/pkg_add -v pkgin
            pkgin update
            pkgin install -y gmake
            pkgin install -y openmp
            rm -rf artifact
            mkdir artifact
            gmake CC=cc -B
            chmod +x udu
            cp udu udu.1 COPYING artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-aarch64-netbsd
          path: artifact/

  release:
    needs: 
      - build-linux-x86_64
      - build-linux-aarch64
      - build-macos-intel
      - build-macos-arm
      - build-freebsd-x86_64
      - build-freebsd-aarch64
      - build-netbsd-x86_64
      - build-netbsd-aarch64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Extract version
        id: version
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#udu@}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Package artifacts
        run: |
          cd artifacts
          for d in */; do
            chmod +x "$d/udu"
            tar -czf "../$(basename "$d").tar.gz" -C "$d" .
          done
          cd ..
          sha256sum *.tar.gz > checksums.txt
      - uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.version.outputs.version }}
          body: |
            *Linux binaries are built with GCC 15*

            *MacOS binaries are built with LLVM 21*

            *BSD binaries are built with system toolchain (LLVM)*
          files: |
            *.tar.gz
            checksums.txt
